<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>Ë©¶È®ìÂØæÁ≠ñ„Ç¢„Éó„É™</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0;
    padding: 0.5rem;
    background: #f9f9f9;
    color: #333;
    font-size: 18px;
    line-height: 1.6;
  }
  h1 {
    text-align: center;
    font-size: 1.8rem;
    margin: 1.5rem 0 2rem;
    color: #2c3e50;
  }
  .container {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    box-sizing: border-box;
  }
  .tag-btn {
    display: block;
    width: 100%;
    padding: 1.8rem 1rem;
    margin: 1.2rem 0;
    border: 1px solid #dcdde1;
    border-radius: 15px;
    font-size: 1.3rem;
    font-weight: bold;
    background: #fff;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    color: #2f3640;
    text-decoration: none;
    box-sizing: border-box;
  }
  .tag-btn:active {
    background: #f5f6fa;
    transform: scale(0.98);
  }
  .btn-s1 { border-left: 10px solid #f1c40f; }
  .btn-s2 { border-left: 10px solid #e74c3c; }
  .btn-s3 { border-left: 10px solid #3498db; }

  #question { margin: 1.5rem 0.5rem; font-size: 1.25rem; font-weight: bold; line-height: 1.5; }
  #options { list-style: none; padding: 0; }
  #options li { margin-bottom: 0.8rem; }
  #options button {
    width: 100%; padding: 1.3rem; font-size: 1.1rem; border: 1px solid #ccc;
    border-radius: 12px; background: #fff; text-align: left;
  }
  #options button:disabled { opacity: 0.8; }
  #progress { text-align: center; margin-top: 1.5rem; color: #888; font-size: 0.9rem; }

  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7); display: none;
    align-items: center; justify-content: center; z-index: 100;
  }
  #modal { background: #fff; padding: 1.5rem; border-radius: 15px; width: 88%; max-width: 400px; box-sizing: border-box; }
  #modal-message { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1rem; }
  #modal-explanation {
    font-size: 0.95rem; color: #444; margin-top: 1rem;
    border-top: 1px solid #eee; padding-top: 1rem; line-height: 1.6;
  }
  #modalNextBtn {
    display: block; width: 100%; padding: 1.3rem; margin-top: 1.5rem;
    border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold;
    background: #3498db; color: #fff;
  }
</style>
</head>
<body>

<div class="container">
  <h1 id="mainTitle">Ë©¶È®ìÂØæÁ≠ñ„Ç¢„Éó„É™</h1>

  <div id="term-select">
    <button class="tag-btn btn-s1" onclick="showSubjects('01')">1Â≠¶Êúü</button>
    <button class="tag-btn btn-s2" onclick="showSubjects('02')">2Â≠¶Êúü</button>
    <button class="tag-btn btn-s3" onclick="showSubjects('03')">3Â≠¶Êúü</button>
  </div>

  <div id="subject-select" style="display:none;">
    <button class="tag-btn" data-tag="info1">ÊÉÖÂ†±I</button>
    <button class="tag-btn" data-tag="info2">ÊÉÖÂ†±II</button>
    <button class="tag-btn" data-tag="appA" id="btn-appA">„Ç¢„Éó„É™A</button>
    <button class="tag-btn" data-tag="appB" id="btn-appB">„Ç¢„Éó„É™B</button>
  </div>

  <div id="quiz" style="display:none;">
    <div id="question"></div>
    <ul id="options"></ul>
    <div id="progress"></div>
  </div>

  <div id="result" style="display:none; text-align:center;">
    <div id="result-content"></div>
    <button class="tag-btn" style="background:#d4edda; border-color:#28a745;" onclick="restartWithNewQuestions()">Á∂ö„Åë„ÇãÔºàÊ¨°„ÅÆ20ÂïèÔºâ</button>
  </div>
</div>

<div id="overlay">
  <div id="modal">
    <div id="modal-message"></div>
    <div id="modal-explanation"></div>
    <button id="modalNextBtn">Ê¨°„Å∏ ‚ñ∂</button>
  </div>
</div>

<script>
  let allQuestions = []; 
  let questions = [];    
  let current = 0, score = 0, selectedTerm = '';

  function showSubjects(term) {
    selectedTerm = term;
    document.getElementById('term-select').style.display = 'none';
    document.getElementById('subject-select').style.display = 'block';
    const isTerm2 = (term === '02');
    document.getElementById('btn-appA').style.display = isTerm2 ? 'none' : 'block';
    document.getElementById('btn-appB').style.display = isTerm2 ? 'none' : 'block';
    document.querySelectorAll('#subject-select .tag-btn[data-tag]').forEach(btn => {
      btn.onclick = () => startQuiz(btn.dataset.tag);
    });
  }

  async function startQuiz(tag) {
    document.getElementById('subject-select').style.display = 'none';
    document.getElementById('mainTitle').style.display = 'none'; 
    const fileName = `${tag}_${selectedTerm}.csv`;
    try {
      allQuestions = await loadCSV(fileName);
    } catch(err) {
      alert("CSVË™≠„ÅøËæº„ÅøÂ§±Êïó: " + fileName);
      location.reload();
      return;
    }
    restartWithNewQuestions();
  }

  function restartWithNewQuestions() {
    document.getElementById('result').style.display = 'none';
    questions = shuffle([...allQuestions]).slice(0, 20);
    current = 0; score = 0;
    document.getElementById('quiz').style.display = 'block';
    showQuestion();
  }

  async function loadCSV(file) {
    const response = await fetch(file);
    const text = await response.text();
    const parseCsvLine = (line) => {
      const result = [];
      let currentField = '', inQuote = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuote && line[i + 1] === '"') { currentField += '"'; i++; }
          else inQuote = !inQuote;
        } else if (char === ',' && !inQuote) {
          result.push(currentField);
          currentField = '';
        } else currentField += char;
      }
      result.push(currentField);
      return result.map(f => f.startsWith('"') && f.endsWith('"') ? f.slice(1, -1).replace(/""/g, '"') : f);
    };
    return text.trim().split(/\r?\n/).slice(1).map(line => {
      if (!line) return null;
      const c = parseCsvLine(line);
      if (c.length < 4) return null;
      return { q: c[1], options: c.slice(2, c.length - 2).filter(opt => opt.trim() !== ""), answer: +c[c.length - 2] - 1, explanation: c[c.length - 1] };
    }).filter(q => q !== null);
  }

  function shuffle(a) {
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function showQuestion() {
    const q = questions[current];
    document.getElementById('question').innerHTML = q.q;
    const ul = document.getElementById('options');
    ul.innerHTML = '';
    q.options.forEach((opt, i) => {
      const li = document.createElement('li');
      li.innerHTML = `<button>${opt}</button>`;
      li.firstChild.onclick = () => selectAnswer(i);
      ul.appendChild(li);
    });
    document.getElementById('progress').textContent = `${current + 1} / ${questions.length}`;
  }

  function selectAnswer(idx) {
    const q = questions[current];
    const btns = document.getElementById('options').querySelectorAll('button');
    btns.forEach((btn, i) => {
      btn.disabled = true;
      if (i === q.answer) btn.style.background = '#d4edda';
      else if (i === idx) btn.style.background = '#f8d7da';
    });
    const isCorrect = (idx === q.answer);
    if (isCorrect) score++;
    document.getElementById('modal-message').innerHTML = isCorrect ? 'üü¢ Ê≠£Ëß£ÔºÅ' : '‚ùå ‰∏çÊ≠£Ëß£';
    document.getElementById('modal-explanation').innerHTML = "<strong>Ëß£Ë™¨:</strong><br>" + q.explanation;
    document.getElementById('overlay').style.display = 'flex';
  }

  document.getElementById('modalNextBtn').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    if (++current < questions.length) showQuestion();
    else showResults();
  };

  function showResults() {
    document.getElementById('quiz').style.display = 'none';
    const r = document.getElementById('result');
    document.getElementById('result-content').innerHTML = `
      <h2 style="margin-top:0;">ÁµêÊûú</h2>
      <div style="font-size:2.5rem; font-weight:bold; margin-bottom:1rem;">${score} / ${questions.length}</div>
    `;
    r.style.display = 'block';
  }
</script>
</body>
</html>
