<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>è©¦é¨“å¯¾ç­–ã‚¢ãƒ—ãƒª</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    margin: 0;
    padding: 0.5rem;
    background: #f9f9f9;
    color: #333;
    font-size: 18px;
    line-height: 1.6;
  }
  h1 {
    text-align: center;
    font-size: 1.8rem;
    margin: 1.5rem 0 2rem;
    color: #2c3e50;
  }
  .container {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    box-sizing: border-box;
  }
  .tag-btn {
    display: block;
    width: 100%;
    padding: 1.8rem 1rem;
    margin: 1.2rem 0;
    border: 1px solid #dcdde1;
    border-radius: 15px;
    font-size: 1.3rem;
    font-weight: bold;
    background: #fff;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    color: #2f3640;
    text-decoration: none;
    box-sizing: border-box;
  }
  .tag-btn:active {
    background: #f5f6fa;
    transform: scale(0.98);
  }
  .btn-s1 { border-left: 10px solid #f1c40f; }
  .btn-s2 { border-left: 10px solid #e74c3c; }
  .btn-s3 { border-left: 10px solid #3498db; }

  #question { margin: 1.5rem 0.5rem; font-size: 1.25rem; font-weight: bold; line-height: 1.5; }
  #options { list-style: none; padding: 0; }
  #options li { margin-bottom: 0.8rem; }
  #options button {
    width: 100%; padding: 1.3rem; font-size: 1.1rem; border: 1px solid #ccc;
    border-radius: 12px; background: #fff; text-align: left;
  }
  #options button:disabled { opacity: 0.8; }
  #progress { text-align: center; margin-top: 1.5rem; color: #888; font-size: 0.9rem; }

  #overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.7); display: none;
    align-items: center; justify-content: center; z-index: 100;
  }
  #modal { background: #fff; padding: 1.5rem; border-radius: 15px; width: 88%; max-width: 400px; box-sizing: border-box; }
  #modal-message { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1rem; }
  #modal-explanation {
    font-size: 0.95rem; color: #444; margin-top: 1rem;
    border-top: 1px solid #eee; padding-top: 1rem; line-height: 1.6;
  }
  #modalNextBtn {
    display: block; width: 100%; padding: 1.3rem; margin-top: 1.5rem;
    border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold;
    background: #3498db; color: #fff;
  }
</style>
</head>
<body>

<div class="container">
  <h1 id="mainTitle">è©¦é¨“å¯¾ç­–ã‚¢ãƒ—ãƒª</h1>

  <div id="term-select">
    <button class="tag-btn btn-s1" onclick="showSubjects('01')">1å­¦æœŸ</button>
    <button class="tag-btn btn-s2" onclick="showSubjects('02')">2å­¦æœŸ</button>
    <button class="tag-btn btn-s3" onclick="showSubjects('03')">3å­¦æœŸ</button>
  </div>

  <div id="subject-select" style="display:none;">
    <button class="tag-btn" data-tag="info1">æƒ…å ±I</button>
    <button class="tag-btn" data-tag="info2">æƒ…å ±II</button>
    <button class="tag-btn" data-tag="appA" id="btn-appA">ã‚¢ãƒ—ãƒªA</button>
    <button class="tag-btn" data-tag="appB" id="btn-appB">ã‚¢ãƒ—ãƒªB</button>
  </div>

  <div id="quiz" style="display:none;">
    <div id="question"></div>
    <ul id="options"></ul>
    <div id="progress"></div>
  </div>

  <div id="result" style="display:none; text-align:center;">
    <div id="result-content"></div>
    <button class="tag-btn" style="background:#d4edda; border-color:#28a745;" onclick="restartWithNewQuestions()">ç¶šã‘ã‚‹ï¼ˆæ¬¡ã®20å•ï¼‰</button>
  </div>
</div>

<div id="overlay">
  <div id="modal">
    <div id="modal-message"></div>
    <div id="modal-explanation"></div>
    <button id="modalNextBtn">æ¬¡ã¸ â–¶</button>
  </div>
</div>

<script>
  let allQuestions = []; 
  let questions = [];    
  let current = 0, score = 0, selectedTerm = '', currentFileName = '';

  function showSubjects(term) {
    selectedTerm = term;
    document.getElementById('term-select').style.display = 'none';
    document.getElementById('subject-select').style.display = 'block';
    const isTerm2 = (term === '02');
    document.getElementById('btn-appA').style.display = isTerm2 ? 'none' : 'block';
    document.getElementById('btn-appB').style.display = isTerm2 ? 'none' : 'block';
    document.querySelectorAll('#subject-select .tag-btn[data-tag]').forEach(btn => {
      btn.onclick = () => startQuiz(btn.dataset.tag);
    });
  }

  async function startQuiz(tag) {
    document.getElementById('subject-select').style.display = 'none';
    document.getElementById('mainTitle').style.display = 'none'; 
    currentFileName = `${tag}_${selectedTerm}.csv`;
    try {
      allQuestions = await loadCSV(currentFileName);
    } catch(err) {
      alert("CSVèª­ã¿è¾¼ã¿å¤±æ•—: " + currentFileName);
      location.reload();
      return;
    }
    restartWithNewQuestions();
  }

  // é€²æ—ç®¡ç†ï¼ˆlocalStorageã‚’ä½¿ç”¨ï¼‰
  function getClearedIds() {
    const data = localStorage.getItem('cleared_' + currentFileName);
    return data ? JSON.parse(data) : [];
  }

  function saveClearedId(id) {
    let cleared = getClearedIds();
    if (!cleared.includes(id)) {
      cleared.push(id);
      localStorage.setItem('cleared_' + currentFileName, JSON.stringify(cleared));
    }
  }

  function restartWithNewQuestions() {
    document.getElementById('result').style.display = 'none';
    const clearedIds = getClearedIds();
    
    // æœªæ­£è§£ã®å•é¡Œã¨æ­£è§£æ¸ˆã¿ã®å•é¡Œã‚’åˆ†é›¢
    const unsolved = allQuestions.filter(q => !clearedIds.includes(q.id));
    const solved = allQuestions.filter(q => clearedIds.includes(q.id));

    // æœªæ­£è§£ã‚’å„ªå…ˆã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«æŠ½å‡º
    let selection = shuffle([...unsolved]);
    if (selection.length < 20) {
      const needed = 20 - selection.length;
      selection = selection.concat(shuffle([...solved]).slice(0, needed));
    } else {
      selection = selection.slice(0, 20);
    }

    questions = selection;
    current = 0; score = 0;
    document.getElementById('quiz').style.display = 'block';
    showQuestion();
  }

  async function loadCSV(file) {
    const response = await fetch(file);
    const text = await response.text();
    const parseCsvLine = (line) => {
      const result = [];
      let currentField = '', inQuote = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuote && line[i + 1] === '"') { currentField += '"'; i++; }
          else inQuote = !inQuote;
        } else if (char === ',' && !inQuote) {
          result.push(currentField);
          currentField = '';
        } else currentField += char;
      }
      result.push(currentField);
      return result.map(f => f.startsWith('"') && f.endsWith('"') ? f.slice(1, -1).replace(/""/g, '"') : f);
    };

    return text.trim().split(/\r?\n/).slice(1).map(line => {
      if (!line.trim()) return null;
      const c = parseCsvLine(line);
      if (c.length < 4) return null;
      // CSVæ§‹æˆ: ID, å•é¡Œ, é¸æŠè‚¢..., æ­£è§£ç•ªå·, è§£èª¬
      const id = c[0];
      const answerNum = parseInt(c[c.length - 2]);
      const explanationTxt = c[c.length - 1];
      const opts = c.slice(2, c.length - 2).filter(opt => opt && opt.trim() !== "");
      return { id: id, q: c[1], options: opts, answer: answerNum - 1, explanation: explanationTxt };
    }).filter(q => q !== null);
  }

  function shuffle(a) {
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function showQuestion() {
    const q = questions[current];
    document.getElementById('question').innerHTML = q.q;
    const ul = document.getElementById('options');
    ul.innerHTML = '';
    q.options.forEach((opt, i) => {
      const li = document.createElement('li');
      li.innerHTML = `<button>${opt}</button>`;
      li.firstChild.onclick = () => selectAnswer(i);
      ul.appendChild(li);
    });
    document.getElementById('progress').textContent = `${current + 1} / ${questions.length}`;
  }

  function selectAnswer(idx) {
    const q = questions[current];
    const btns = document.getElementById('options').querySelectorAll('button');
    btns.forEach((btn, i) => {
      btn.disabled = true;
      if (i === q.answer) btn.style.background = '#d4edda';
      else if (i === idx) btn.style.background = '#f8d7da';
    });
    const isCorrect = (idx === q.answer);
    if (isCorrect) {
      score++;
      saveClearedId(q.id); // æ­£è§£ã—ãŸIDã‚’å†…éƒ¨çš„ã«ä¿å­˜
    }

    const correctText = q.options[q.answer];
    document.getElementById('modal-message').innerHTML = isCorrect ? 'ğŸŸ¢ æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£';
    document.getElementById('modal-explanation').innerHTML = 
      "æ­£è§£ï¼š<strong>" + correctText + "</strong><br><br>" + 
      "<strong>è§£èª¬:</strong><br>" + q.explanation;
    
    document.getElementById('overlay').style.display = 'flex';
  }

  document.getElementById('modalNextBtn').onclick = () => {
    document.getElementById('overlay').style.display = 'none';
    if (++current < questions.length) showQuestion();
    else showResults();
  };

  function showResults() {
    document.getElementById('quiz').style.display = 'none';
    const r = document.getElementById('result');
    document.getElementById('result-content').innerHTML = `
      <h2 style="margin-top:0;">çµæœ</h2>
      <div style="font-size:2.5rem; font-weight:bold; margin-bottom:1rem;">${score} / ${questions.length}</div>
    `;
    r.style.display = 'block';
  }
</script>
</body>
</html>
